# 第12章 ClickHouse

## 1 ClickHouse简介

ClickHouse是俄罗斯的Yandex于2016年开源的列式存储数据库(DBMS)，使用C++语言编写，主要用于在线分析处理查询(OLAP)，能够使用SQL查询实时生成分析数据报告。

### 1.1 OLAP场景的关键特征

- 绝大多数是读请求
- 数据以相当大的批次（> 1000行）更新，而不是单行更新，或者根本没有更新。
- 已添加到数据库的数据不能修改。
- 对于读取，从数据库中提取相当多的行，但只提取列的一小部分。
- 宽表，即每个表包含着大量的列
- 查询相对较少（通常每台服务器每秒查询数百次或更少）
- 对于简单查询，允许延迟大约50毫秒
- 列中的数据相对较小：数字和短字符串（例如，每个URL 60个字节）
- 处理单个查询时需要高吞吐量（每台服务器每秒可达数十亿行）
- 事务不是必须的
- 对数据一致性要求低
- 每个查询有一个大表

### 1.2 特点

- 列式存储：对于列的聚合、计数、求和等统计操作原因优于行式存储。
- DBMS功能：几乎覆盖了标准SQL的大部分语法，包括DDL和DML，以及配套的各种函数、用户管理及权限管理、数据的备份与恢复。
- 多样化引擎：包括括合并树、日志、接口和其他四大类20多种引擎。
- 高吞吐写入能力：采用类LSM Tree的结构，数据写入后，定期在后台进行Compaction。通过类LSM Tree的结构，ClickHouse在数据导入时全部是顺序append写，写入后数据段不可更改，在后台compaction时也是多个段merge sort后顺序写回磁盘。顺序写的特性，充分利用了磁盘的吞吐能力，即便在HDD上也有着优异的写入性能。
- 数据分区与线程级并行：单条Query就能利用整机所有CPU。

### 1.3 缺点

- 不支持事务
- 不支持行级别的更新和删除操作
- 存储格式限制

## 2 ClickHouse部署

注：默认用户`default`，密码无

### 2.1 Ubuntu快速安装

1. 安装`ca-certificates`
```shell
sudo apt install apt-transport-https ca-certificates
```

2. 添加`yandex`源
```shell
sudo apt-key adv --keyserver keyserver.ubuntu.com --recv E0C56BD4
echo "deb http://repo.yandex.ru/clickhouse/deb/stable/ main/" | sudo tee /etc/apt/sources.list.d/clickhouse.list
sudo apt update
```

3. 安装ClickHouse
```shell
sudo apt install clickhouse-server clickhouse-client
```

4. 配置外网访问 
   
在`/etc/clickhouse-server/config.xml`文件中修改以下内容，
```xml
<listen_host>::</listen_host>
```

5. 启动ClickHouse
```shell
sudo systemctl start clickhouse-server
```

### 2.2 离线部署

1. 访问[ClickHouse官网](https://packages.clickhouse.com/repo-archive/tgz/)，下载以下4个包，在`/data/soft`目录下解压
- clickhouse-common-static：ClickHouse编译的二进制文件。 
- clickhouse-server：创建clickhouse-server软连接，并安装默认配置服务
- clickhouse-client：创建clickhouse-client客户端工具软连接，并安装客户端配置文件。
- clickhouse-common-static-dbg：带有调试信息的ClickHouse二进制文件。

2. 依次执行安装包中的`doinst.sh`脚本
```shell
cd /data/soft/clickhouse-common-static/install
sudo doinst.sh
cd /data/soft/clickhouse-common-static-dbg/install
sudo doinst.sh
cd /data/soft/clickhouse-server/install
sudo doinst.sh configure
cd /data/soft/clickhouse-client/install
sudo doinst.sh
```

3. 配置外网访问

在`/etc/clickhouse-server/config.xml`文件中修改以下内容，
```xml
<listen_host>::</listen_host>
```

4. 启动ClickHouse
```shell
sudo /etc/init.d/clickhouse-server start
```

## 3 数据类型

- 整型：Int8、Int16、Int32、Int64、UInt8、UInt16、UInt32、UInt64
- 浮点型：Float32、Float64
- 布尔型：可以使用UInt8类型，取值限制为0或1
- Decimal型：
  - Decimal32(s)：相当于Decimal(9-s, s)
  - Decimal64(s)：相当于Decimal(18-s, s)
  - Decimal128(s)：相当于Decimal(38-s, s)
- 字符串：String、FixedString(N)
- 枚举类型：Enum8、Enum16
- 时间类型：Date、Datetime、Datetime64
- 数组：Array(T)

## 4 表引擎

- TinyLog：以列文件的形式保存在磁盘上，不支持索引，没有并发控制，保存少量数据的小表
- Memory：内存引擎，服务器重启之后，数据就会消失，读写操作不会相互阻塞，不支持索引
- MergeTree：支持索引和分区
- ReplacingMergeTree：支持去重功能，仅在分区内部进行去重，适用于后台去重数据
- SummingMergeTree：对于不查询明细，只关心以维度进行汇总聚合结果的场景。


 